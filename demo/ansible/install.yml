- hosts: all
  name: Get our Hetzner instance ready for running the demo
  tasks:
    # Download and install Rustup
    - name: Download Rustup Installer
      get_url:
        url: https://sh.rustup.rs
        dest: /tmp/rustup.rs
        mode: '0755'
        force: 'yes'
      tags:
        - rust
    - name: install rust/cargo
      shell: /tmp/rustup.rs -y
      tags:
        - rust
    - name: Remove Rustup Installer
      file:
        path: /tmp/rustup.rs
        state: absent
    - name: Install the nightly version of rust
      shell: rustup toolchain install nightly
      environment:
        PATH: "{{ ansible_env.PATH }}:{{ ansible_env.HOME }}/.cargo/bin"

    # Clone and install the Dataprep repo
    - name: Clone the dataprep repo
      git:
        repo: "{{ dataprep_repo }}"
        version: "{{ dataprep_branch }}"
        dest: "dataprep"
        update: yes
    # For now, just wipe target and install the binary
    - name: Wipe target
      shell: cargo +nightly clean
      args:
        chdir: "dataprep"
      environment:
        PATH: "{{ ansible_env.PATH }}:{{ ansible_env.HOME }}/.cargo/bin"
    - name: Install the Dataprep binary
      shell: cargo +nightly install --path dataprep
      args:
        chdir: "dataprep"
      environment:
        PATH: "{{ ansible_env.PATH }}:{{ ansible_env.HOME }}/.cargo/bin"