# Install our Rust binaries on the host
# Requires having Git, Rust, Cargo, and the nightly version of Rust installed on the host
# Arguments:
# -e install_path=/home # The directory where we should install our binaries

- hosts: all
  become: yes
  tasks:
    # Create and own the install directory
    - name: Create the install directory
      file:
        path: "{{ install_path }}"
        state: directory
        owner: "{{ ansible_user }}"

    # Install the Dataprep binaries
    - name: Clone the dataprep repo
      git:
        repo: https://github.com/banyancomputer/dataprep.git
        dest: "{{ install_path }}/dataprep"
        update: yes
    - name: Build production
      shell: export PATH="$HOME/.cargo/bin:$PATH"; cargo +nightly build --release --manifest-path Cargo.toml
      args:
        chdir: "{{ install_path }}/dataprep"
    - name: Install the dataprep package
      shell: export PATH="$HOME/.cargo/bin:$PATH"; cargo +nightly install  --path ./dataprep --root /usr/local
      args:
        chdir: "{{ install_path }}/dataprep"

    # Copy and modify Auxiliary scripts to the host
    # Copy our population script to the host
    - name: Copy the population script to the host
      copy:
        src: populate.sh
        dest: "{{ install_path }}/populate.sh"
    # Make the population script executable
    - name: Make the population script executable
      file:
        path: "{{ install_path }}/populate.sh"
        mode: 0755
    # Delete the link if it already exists
    - name: Delete the link if it already exists
      file:
        path: /usr/local/bin/populate
        state: absent
    # Make the population script callable from anywhere. Force the link to be created if it already exists.
    - name: Make the population script callable from anywhere
      shell: "ln -sf {{ install_path }}/populate.sh /usr/local/bin/populate"
    # Copy our run script to the host
    - name: Copy the run script to the host
      copy:
        src: run.sh
        dest: "{{ install_path }}/run.sh"
    # Make the run script executable by the user
    - name: Make the run script executable
      file:
        path: "{{ install_path }}/run.sh"
        mode: 0755
        owner: "{{ ansible_user }}"
    # Delete the link if it already exists
    - name: Delete the link if it already exists
      file:
        path: /usr/local/bin/run
        state: absent
    # Make the run script callable from anywhere
    - name: Make the run script callable from anywhere
      shell: "ln -s {{ install_path }}/run.sh /usr/local/bin/run"
