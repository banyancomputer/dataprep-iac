# Run our throughput benchmark on the Dataprep Pipeline

# Usage
# ansible-playbook -i inventory/localhost
# -e bench_path=/home/dataprep/bench
# -e input_path=/home/dataprep/input
# -e packed_path=/home/dataprep/packed
# -e unpacked_path=/home/dataprep/unpacked
# -e manifest_path=/home/dataprep/manifest
# -e ifttt_webhook_key=YOUR_KEY
# -e file_structures=simpele,wide,...
# -e file_structures_size=1024
# -e file_structures_max_width=2
# -e file_structures_max_depth=2
# -e sample_size=10
# -e sample_time=30
# -e warmup_time=5
# -e do_correctness_check=true
# ./bench_throughput.yml


- hosts: all
  name: Run our tests
  tasks:
    # Run our benchmark
    - name: Run our throughput benchmark on the Dataprep Pipeline
      shell: "cargo +nightly criterion --bench pipeline"
      args:
          chdir: "{{ bench_path }}/dataprep"
      environment:
          # Set the PATH to include the cargo bin directory
          PATH: "{{ ansible_env.PATH }}:{{ ansible_env.HOME }}/.cargo/bin"
          # Configure paths for the benchmark
          BENCH_PATH: "{{ bench_path }}"
          INPUT_PATH: "{{ input_path }}"
          PACKED_PATH: "{{ packed_path }}"
          UNPACKED_PATH: "{{ unpacked_path }}"
          # Configure the IFTTT webhook key
          IFTTT_WEBHOOK_KEY: "{{ ifttt_webhook_key }}"
          # Configure the file structures to test
          BENCH_FILE_STRUCTURES: "{{ file_structures }}"
          BENCH_FILE_STRUCTURES_SIZE: "{{ file_structures_size }}"
          BENCH_FILE_STRUCTURES_MAX_WIDTH: "{{ file_structures_max_width }}"
          BENCH_FILE_STRUCTURES_MAX_DEPTH: "{{ file_structures_max_depth }}"
          # Configure Criterion
          BENCH_SAMPLE_SIZE: "{{ sample_size }}"
          BENCH_SAMPLE_TIME: "{{ sample_time }}"
          BENCH_WARMUP_TIME: "{{ warmup_time }}"
          BENCH_DO_CORRECTNESS_CHECK: "{{ do_correctness_check }}"
      register: run_bench
    - debug:
        var: run_bench.stdout_lines

